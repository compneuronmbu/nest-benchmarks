<?xml version="1.0" encoding="UTF-8"?>
<jube>


  <parameterset name="magainin">
    <parameter name="benchmark_system_name" type="string">
      magainin
    </parameter>
    <parameter name="number_of_atoms" type="int">
      34573
    </parameter>
    <parameter name="tprfile" type="string">
      ${benchmark_home}/${benchmark_system_name}.tpr
    </parameter>
  </parameterset>

  <parameterset name="bombinin">
    <parameter name="benchmark_system_name" type="string">
      bombinin
    </parameter>
    <parameter name="number_of_atoms" type="int">
      325315
    </parameter>
    <parameter name="tprfile" type="string">
      ${benchmark_home}/${benchmark_system_name}.tpr
    </parameter>
  </parameterset>

  <benchmark name="magainin_2018_sdv_1n" outpath="./magainin-2018-sdv-1n">
    <!-- Load jobfile -->
    <fileset name="files">
      <copy>${job_file}.in</copy>
      <copy name="topol.tpr">$tprfile</copy>
    </fileset>
    
    <!-- Substitute jobfile -->
    <substituteset name="sub_job">
      <iofile in="${job_file}.in" out="$job_file" />
      <sub source="#PARTITION#" dest="$partition" />
      <sub source="#NODES#" dest="$nodes" />
      <sub source="#NTASKS_PER_NODE#" dest="$ppn" />
      <sub source="#THREADS_PER_CORE#" dest="$threads_per_core" />
      <sub source="#TIME#" dest="$walltime" />
      <sub source="#ERRPATH#" dest="$err_file" />
      <sub source="#OUTPATH#" dest="$out_file" />
      <sub source="#COMMANDS#" dest="$exec" />
      <sub source="#READY#" dest="$ready_file" />
      <sub source="#JOB_NAME#" dest="$job_name" />
    </substituteset> 

    <parameterset name="executeset">
      <parameter name="submit_cmd">sbatch</parameter>
      <parameter name="job_file">job.slurm</parameter>
      <parameter name="partition">$system_name</parameter>
      <parameter name="nodes" type="int">$NUMBER_of_NODES</parameter>
      <parameter name="ppn" type="int">$MPIS_per_NODE</parameter>
      <parameter name="totMPIs" type="int" mode="python">$NUMBER_of_NODES*$MPIS_per_NODE</parameter>
      <parameter name="threads_per_core" type="int">$THREADS_per_MPI</parameter>            
      <parameter name="job_name" type="string">${benchmark_system_name}-gmx-$version-$system_name</parameter>      
      <parameter name="walltime">01:00:00</parameter>
      <parameter name="ready_file">ready</parameter>
      <parameter name="err_file">stderr</parameter>
      <parameter name="out_file">stdout</parameter>
      <parameter name="exec">
	module purge;
	module load $modules;
	source ${GMXINSTDIR}/bin/GMXRC;

	export PSP_VELO=0 
	export PSP_ONDEMAND=1

	srun -N $nodes -n $totMPIs gmx mdrun -s topol.tpr -deffnm log-${nodes}N-${ppn}mpis-${threads_per_core}thrds -noconfout -v -resethway -ntomp $THREADS_per_MPI -nsteps 50000 -dlb yes
      </parameter>
    </parameterset>

    <!-- Regex pattern -->
    <patternset name="pattern_stderr">
      <pattern name="gmx_performance" type="float">Performance:$jube_pat_bl$jube_pat_fp$jube_pat_bl$jube_pat_nfp$jube_pat_bl</pattern>
    </patternset>


<!-- 1n_1mpi -->

    <parameterset name="comp_resources_conf_1">
      <parameter name="NUMBER_of_NODES" type="int">1</parameter>
      <parameter name="MPIS_per_NODE" type="int">1</parameter>
      <parameter name="THREADS_per_MPI" type="int">24,48</parameter>
    </parameterset>

    <step name="magainin_1n_1mpi">
      <use >magainin</use>
      <use from="gmx-2018-compile-sdv.xml">GROMACS_REPO</use>
      <use from="gmx-2018-compile-sdv.xml">gromacs_2018</use>
      <use from="gmx-2018-compile-sdv.xml">system_sdv</use>
      <use>comp_resources_conf_1</use>
      <use>executeset</use>
      <use>files,sub_job</use>
      <do done_file="$ready_file">$submit_cmd $job_file</do>
    </step>

    <!-- Analyse -->
    <analyser name="analyse_magainin_1n_1mpi">
      <use>pattern_stderr</use> <!-- use existing patternset -->
      <analyse step="magainin_1n_1mpi">
	<file>stderr</file> <!-- file which should be scanned -->
      </analyse>
    </analyser>
    <!-- Create result table -->
    <result>
      <use>analyse_magainin_1n_1mpi</use> <!-- use existing analyser -->
      <table name="result_1n_1mpi" style="pretty" sort="number">
	<column>NUMBER_of_NODES</column>
	<column>MPIS_per_NODE</column>
	<column>THREADS_per_MPI</column>
	<column>totMPIs</column>
	<column>gmx_performance</column>	
      </table>
    </result>

<!--  1n_2mpi -->

    <parameterset name="comp_resources_conf_2">
      <parameter name="NUMBER_of_NODES" type="int">1</parameter>
      <parameter name="MPIS_per_NODE" type="int">2</parameter>
      <parameter name="THREADS_per_MPI" type="int">12,24</parameter>
    </parameterset>

    <step name="magainin_1n_2mpi">
      <use >magainin</use>
      <use from="gmx-2018-compile-sdv.xml">GROMACS_REPO</use>
      <use from="gmx-2018-compile-sdv.xml">gromacs_2018</use>
      <use from="gmx-2018-compile-sdv.xml">system_sdv</use>
      <use>comp_resources_conf_2</use>
      <use>executeset</use>
      <use>files,sub_job</use>
      <do done_file="$ready_file">$submit_cmd $job_file</do>
    </step>

    <!-- Analyse -->
    <analyser name="analyse_magainin_1n_2mpi">
      <use>pattern_stderr</use> <!-- use existing patternset -->
      <analyse step="magainin_1n_2mpi">
	<file>stderr</file> <!-- file which should be scanned -->
      </analyse>
    </analyser>
    <!-- Create result table -->
    <result>
      <use>analyse_magainin_1n_2mpi</use> <!-- use existing analyser -->
      <table name="result_1n_2mpi" style="pretty" sort="number">
	<column>NUMBER_of_NODES</column>
	<column>MPIS_per_NODE</column>
	<column>THREADS_per_MPI</column>
	<column>totMPIs</column>
	<column>gmx_performance</column>	
      </table>
    </result>

<!-- 1n_4mpi -->

    <parameterset name="comp_resources_conf_3">
      <parameter name="NUMBER_of_NODES" type="int">1</parameter>
      <parameter name="MPIS_per_NODE" type="int">4</parameter>
      <parameter name="THREADS_per_MPI" type="int">6,12</parameter>
    </parameterset>

    <step name="magainin_1n_4mpi">
      <use >magainin</use>
      <use from="gmx-2018-compile-sdv.xml">GROMACS_REPO</use>
      <use from="gmx-2018-compile-sdv.xml">gromacs_2018</use>
      <use from="gmx-2018-compile-sdv.xml">system_sdv</use>
      <use>comp_resources_conf_3</use>
      <use>executeset</use>
      <use>files,sub_job</use>
      <do done_file="$ready_file">$submit_cmd $job_file</do>
    </step>

    <!-- Analyse -->
    <analyser name="analyse_magainin_1n_4mpi">
      <use>pattern_stderr</use> <!-- use existing patternset -->
      <analyse step="magainin_1n_4mpi">
	<file>stderr</file> <!-- file which should be scanned -->
      </analyse>
    </analyser>
    <!-- Create result table -->
    <result>
      <use>analyse_magainin_1n_4mpi</use> <!-- use existing analyser -->
      <table name="result_1n_4mpi" style="pretty" sort="number">
	<column>NUMBER_of_NODES</column>
	<column>MPIS_per_NODE</column>
	<column>THREADS_per_MPI</column>
	<column>totMPIs</column>
	<column>gmx_performance</column>	
      </table>
    </result>


<!--  1n_8mpi -->

    <parameterset name="comp_resources_conf_4">
      <parameter name="NUMBER_of_NODES" type="int">1</parameter>
      <parameter name="MPIS_per_NODE" type="int">8</parameter>
      <parameter name="THREADS_per_MPI" type="int">3,6</parameter>
    </parameterset>

    <step name="magainin_1n_8mpi">
      <use >magainin</use>
      <use from="gmx-2018-compile-sdv.xml">GROMACS_REPO</use>
      <use from="gmx-2018-compile-sdv.xml">gromacs_2018</use>
      <use from="gmx-2018-compile-sdv.xml">system_sdv</use>
      <use>comp_resources_conf_4</use>
      <use>executeset</use>
      <use>files,sub_job</use>
      <do done_file="$ready_file">$submit_cmd $job_file</do>
    </step>

    <!-- Analyse -->
    <analyser name="analyse_magainin_1n_8mpi">
      <use>pattern_stderr</use> <!-- use existing patternset -->
      <analyse step="magainin_1n_8mpi">
	<file>stderr</file> <!-- file which should be scanned -->
      </analyse>
    </analyser>
    <!-- Create result table -->
    <result>
      <use>analyse_magainin_1n_8mpi</use> <!-- use existing analyser -->
      <table name="result_1n_8mpi" style="pretty" sort="number">
	<column>NUMBER_of_NODES</column>
	<column>MPIS_per_NODE</column>
	<column>THREADS_per_MPI</column>
	<column>totMPIs</column>
	<column>gmx_performance</column>	
      </table>
    </result>


<!--  1n_6mpi -->

    <parameterset name="comp_resources_conf_5">
      <parameter name="NUMBER_of_NODES" type="int">1</parameter>
      <parameter name="MPIS_per_NODE" type="int">6</parameter>
      <parameter name="THREADS_per_MPI" type="int">4,8</parameter>
    </parameterset>

    <step name="magainin_1n_6mpi">
      <use >magainin</use>
      <use from="gmx-2018-compile-sdv.xml">GROMACS_REPO</use>
      <use from="gmx-2018-compile-sdv.xml">gromacs_2018</use>
      <use from="gmx-2018-compile-sdv.xml">system_sdv</use>
      <use>comp_resources_conf_5</use>
      <use>executeset</use>
      <use>files,sub_job</use>
      <do done_file="$ready_file">$submit_cmd $job_file</do>
    </step>

    <!-- Analyse -->
    <analyser name="analyse_magainin_1n_6mpi">
      <use>pattern_stderr</use> <!-- use existing patternset -->
      <analyse step="magainin_1n_6mpi">
	<file>stderr</file> <!-- file which should be scanned -->
      </analyse>
    </analyser>
    <!-- Create result table -->
    <result>
      <use>analyse_magainin_1n_6mpi</use> <!-- use existing analyser -->
      <table name="result_1n_6mpi" style="pretty" sort="number">
	<column>NUMBER_of_NODES</column>
	<column>MPIS_per_NODE</column>
	<column>THREADS_per_MPI</column>
	<column>totMPIs</column>
	<column>gmx_performance</column>	
      </table>
    </result>


<!--  1n_12mpi -->

    <parameterset name="comp_resources_conf_6">
      <parameter name="NUMBER_of_NODES" type="int">1</parameter>
      <parameter name="MPIS_per_NODE" type="int">12</parameter>
      <parameter name="THREADS_per_MPI" type="int">2,4</parameter>
    </parameterset>

    <step name="magainin_1n_12mpi">
      <use >magainin</use>
      <use from="gmx-2018-compile-sdv.xml">GROMACS_REPO</use>
      <use from="gmx-2018-compile-sdv.xml">gromacs_2018</use>
      <use from="gmx-2018-compile-sdv.xml">system_sdv</use>
      <use>comp_resources_conf_6</use>
      <use>executeset</use>
      <use>files,sub_job</use>
      <do done_file="$ready_file">$submit_cmd $job_file</do>
    </step>

    <!-- Analyse -->
    <analyser name="analyse_magainin_1n_12mpi">
      <use>pattern_stderr</use> <!-- use existing patternset -->
      <analyse step="magainin_1n_12mpi">
	<file>stderr</file> <!-- file which should be scanned -->
      </analyse>
    </analyser>
    <!-- Create result table -->
    <result>
      <use>analyse_magainin_1n_12mpi</use> <!-- use existing analyser -->
      <table name="result_1n_12mpi" style="pretty" sort="number">
	<column>NUMBER_of_NODES</column>
	<column>MPIS_per_NODE</column>
	<column>THREADS_per_MPI</column>
	<column>totMPIs</column>
	<column>gmx_performance</column>	
      </table>
    </result>

<!--  1n_24mpi -->

    <parameterset name="comp_resources_conf_7">
      <parameter name="NUMBER_of_NODES" type="int">1</parameter>
      <parameter name="MPIS_per_NODE" type="int">24</parameter>
      <parameter name="THREADS_per_MPI" type="int">1,2</parameter>
    </parameterset>

    <step name="magainin_1n_24mpi">
      <use >magainin</use>
      <use from="gmx-2018-compile-sdv.xml">GROMACS_REPO</use>
      <use from="gmx-2018-compile-sdv.xml">gromacs_2018</use>
      <use from="gmx-2018-compile-sdv.xml">system_sdv</use>
      <use>comp_resources_conf_7</use>
      <use>executeset</use>
      <use>files,sub_job</use>
      <do done_file="$ready_file">$submit_cmd $job_file</do>
    </step>

    <!-- Analyse -->
    <analyser name="analyse_magainin_1n_24mpi">
      <use>pattern_stderr</use> <!-- use existing patternset -->
      <analyse step="magainin_1n_24mpi">
	<file>stderr</file> <!-- file which should be scanned -->
      </analyse>
    </analyser>
    <!-- Create result table -->
    <result>
      <use>analyse_magainin_1n_24mpi</use> <!-- use existing analyser -->
      <table name="result_1n_24mpi" style="pretty" sort="number">
	<column>NUMBER_of_NODES</column>
	<column>MPIS_per_NODE</column>
	<column>THREADS_per_MPI</column>
	<column>totMPIs</column>
	<column>gmx_performance</column>	
      </table>
    </result>


  </benchmark>
</jube>

